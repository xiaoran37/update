name: 'Update freetv â˜ âœ”ï¸'

on:
  schedule:
    - cron: '10 20 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Daily Job(freetv)'
        required: true
        default: 'production'

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç¡®ä¿ä»“åº“å†™å…¥æƒé™
      actions: read    # è¯»å–å·¥ä½œæµçŠ¶æ€ï¼ˆé”™è¯¯æ•è·ç”¨ï¼‰

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4  # å‡çº§åˆ°æœ€æ–°ç¨³å®šç‰ˆ
      with:
        ref: main
        fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…å†²çª

    - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç ï¼ˆä¿®å¤ä»“åº“é‡å»ºåœºæ™¯ï¼‰
      run: |
        git fetch origin main --prune
        git reset --hard origin/main
        git clean -fd  # æ¸…ç†æœªè·Ÿè¸ªæ–‡ä»¶/ç›®å½•ï¼Œé¿å…æ®‹ç•™å¹²æ‰°

    - name: Set up Python
      uses: actions/setup-python@v5  # å‡çº§ä¾èµ–ï¼Œé€‚é…3.10+
      with:
        python-version: '3.10'
        cache: 'pip'  # ç¼“å­˜ä¾èµ–ï¼ŒåŠ é€Ÿæ‰§è¡Œ

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # è‹¥è„šæœ¬æœ‰ä¾èµ–ï¼Œæ·»åŠ  requirements.txt å®‰è£…ï¼ˆæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰
        if [ -f "assets/freetv/requirements.txt" ]; then
          pip install -r assets/freetv/requirements.txt
        fi

    - name: åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå®¹é”™å¤„ç†ï¼‰
      run: mkdir -p output/freetv history/freetv  # ç¡®ä¿ç›®å½•å­˜åœ¨ï¼Œé¿å…è„šæœ¬æ‰§è¡Œå¤±è´¥

    - name: è¿è¡ŒPythonè„šæœ¬ç”Ÿæˆæ–‡ä»¶
      run: |
        # æ‰§è¡Œè„šæœ¬å¹¶è¾“å‡ºæ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥å¤±è´¥åŸå› 
        python assets/freetv/freetv.py 2>&1 | tee output/freetv/script_execution.log
      id: script_run  # æ ‡è®°æ­¥éª¤IDï¼Œç”¨äºåç»­é”™è¯¯åˆ¤æ–­

    - name: æ ¡éªŒç”Ÿæˆæ–‡ä»¶æ˜¯å¦å­˜åœ¨
      run: |
        # å®šä¹‰å¿…é¡»å­˜åœ¨çš„æ–‡ä»¶åˆ—è¡¨
        required_files=(
          "output/freetv/freetv_output.txt"
          "output/freetv/freetv_output_cctv.txt"
          "output/freetv/freetv_output_ws.txt"
          "output/freetv/freetv_output_other.txt"
        )
        # é€ä¸ªæ£€æŸ¥æ–‡ä»¶
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ é”™è¯¯ï¼šå¿…éœ€æ–‡ä»¶ $file ä¸å­˜åœ¨ï¼"
            exit 1
          elif [ ! -s "$file" ]; then
            echo "âŒ é”™è¯¯ï¼šæ–‡ä»¶ $file ä¸ºç©ºï¼"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶å‡å­˜åœ¨ä¸”éç©º"

    - name: ä¸Šä¼ ç”Ÿæˆæ–‡ä»¶å’Œæ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: freetv-generated-files
        path: |
          output/freetv/*.txt
          output/freetv/script_execution.log
        retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´

    - name: æ¸…ç†3å¤©å‰çš„å½’æ¡£æ–‡ä»¶
      run: |
        echo "ğŸ—‘ï¸ æ¸…ç†3å¤©å‰çš„æ—§å½’æ¡£æ–‡ä»¶"
        find history/freetv -name "*.zip" -type f -mtime +3 -delete || echo "æ— æ—§æ–‡ä»¶å¯æ¸…ç†"

    - name: ç”Ÿæˆå¹¶æ‰“åŒ…å½’æ¡£æ–‡ä»¶
      run: |
        # ä½¿ç”¨æ ‡å‡†åŒ–æ—¶é—´æ ¼å¼ï¼ˆé¿å…ç©ºæ ¼å¯¼è‡´çš„zipå‘½åé—®é¢˜ï¼‰
        current_datetime=$(date +'%Y%m%d_%H%M%S')
        zip_filename="history/freetv/${current_datetime}_freetv_output.zip"
        # æ‰“åŒ…æ‰€æœ‰è¾“å‡ºæ–‡ä»¶ï¼Œä¿ç•™ç›¸å¯¹è·¯å¾„ç»“æ„ï¼Œé¿å…æ–‡ä»¶ä¸¢å¤±
        zip -r "${zip_filename}" output/freetv/*.txt
        # æ ¡éªŒzipåŒ…å®Œæ•´æ€§
        zip -T "${zip_filename}" || {
          echo "âŒ zipåŒ…æŸåï¼Œæ‰“åŒ…å¤±è´¥ï¼"
          exit 1
        }
        echo "âœ… å½’æ¡£æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼š${zip_filename}"
        echo "ZIP_FILENAME=${zip_filename}" >> $GITHUB_ENV  # ä¿å­˜æ–‡ä»¶ååˆ°ç¯å¢ƒå˜é‡

    - name: æäº¤å¹¶æ¨é€ä¿®æ”¹
      run: |
        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # æ‹‰å–æœ€æ–°ä»£ç ï¼Œé¿å…æ¨é€å†²çª
        git pull origin main --rebase --autostash || {
          echo "âš ï¸  å˜åŸºå†²çªï¼Œä½¿ç”¨è¿œç¨‹ä»£ç è¦†ç›–æœ¬åœ°"
          git rebase --abort
          git pull origin main --force
        }
        
        # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶
        git add output/freetv/*.txt "${{ env.ZIP_FILENAME }}"
        # ä»…åœ¨æœ‰å˜æ›´æ—¶æäº¤
        git diff --quiet --exit-code || {
          git commit -m ":tv: Update freetv data - ${current_datetime}"
          echo "âœ… æäº¤æˆåŠŸ"
        }
        
        # å®‰å…¨æ¨é€ï¼ˆä¼˜å…ˆä½¿ç”¨--force-with-leaseï¼Œé¿å…è¦†ç›–ä»–äººä¿®æ”¹ï¼‰
        git push origin main --force-with-lease || {
          echo "âš ï¸ --force-with-leaseå¤±è´¥ï¼Œä½¿ç”¨--forceå…œåº•"
          git push origin main --force
        }

    - name: æ¨é€å¤±è´¥å…œåº•æ–¹æ¡ˆ
      if: failure() && steps.script_run.outcome == 'success'  # ä»…è„šæœ¬æ‰§è¡ŒæˆåŠŸä½†æ¨é€å¤±è´¥æ—¶è§¦å‘
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
        force: true
        files: |
          output/freetv/*.txt
          history/freetv/*.zip
