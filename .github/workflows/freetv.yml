name: 'Update freetv ☞ ✔️'

on:
  schedule:
    - cron: '10 20 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Daily Job(freetv)'
        required: true
        default: 'production'

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        ref: main
        fetch-depth: 0

    - name: 强制同步远程代码
      run: |
        git fetch origin main --prune
        git reset --hard origin/main
        git clean -fd

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: ''  # 关键：关闭自动缓存检测，解决无requirements.txt的报错

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f "assets/freetv/requirements.txt" ]; then
          pip install -r assets/freetv/requirements.txt
        fi

    - name: 创建输出目录（容错）
      run: mkdir -p output/freetv history/freetv

    - name: 运行Python脚本生成文件
      run: python assets/freetv/freetv.py 2>&1 | tee output/freetv/script_execution.log
      id: script_run

    - name: 校验生成文件
      run: |
        required_files=(
          "output/freetv/freetv_output.txt"
          "output/freetv/freetv_output_cctv.txt"
          "output/freetv/freetv_output_ws.txt"
          "output/freetv/freetv_output_other.txt"
        )
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then echo "❌ 缺失文件 $file"; exit 1; fi
          if [ ! -s "$file" ]; then echo "❌ 文件 $file 为空"; exit 1; fi
        done
        echo "✅ 文件校验通过"

    - name: 上传文件和日志
      uses: actions/upload-artifact@v4
      with:
        name: freetv-generated-files
        path: |
          output/freetv/*.txt
          output/freetv/script_execution.log
        retention-days: 7

    - name: 清理旧归档
      run: find history/freetv -name "*.zip" -type f -mtime +3 -delete || echo "无旧文件"

    - name: 生成并校验zip包
      run: |
        current_datetime=$(date +'%Y%m%d_%H%M%S')
        zip_filename="history/freetv/${current_datetime}_freetv_output.zip"
        zip -r "${zip_filename}" output/freetv/*.txt
        zip -T "${zip_filename}" || { echo "❌ zip包损坏"; exit 1; }
        echo "ZIP_FILENAME=${zip_filename}" >> $GITHUB_ENV

    - name: 提交并推送
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git pull origin main --rebase --autostash || { git rebase --abort; git pull origin main --force; }
        git add output/freetv/*.txt "${{ env.ZIP_FILENAME }}"
        git diff --quiet --exit-code || git commit -m ":tv: Update freetv - ${current_datetime}"
        git push origin main --force-with-lease || git push origin main --force

    - name: 推送兜底
      if: failure() && steps.script_run.outcome == 'success'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
        force: true
        files: |
          output/freetv/*.txt
          history/freetv/*.zip
