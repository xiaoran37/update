name: Universal Cross-Platform Sync (GitHub/Gitee/GitCode)

on:
  schedule:
    - cron: '5 22 * * *'  # UTC 22:05 (Âåó‰∫¨Êó∂Èó¥Ê¨°Êó•6:05)
  workflow_dispatch:
    inputs:
      # Âπ≥Âè∞ÈÄâÊã©
      sync_platform:
        description: 'ÂêåÊ≠•ÁõÆÊ†áÂπ≥Âè∞'
        type: choice
        required: true
        options:
          - 'github'
          - 'gitee'
          - 'gitcode'
        default: 'github'
      
      # Ê∫ê‰ªìÂ∫ìÈÖçÁΩÆ
      source_repo:
        description: 'Ê∫ê‰ªìÂ∫ìÔºàÁî®Êà∑/‰ªìÂ∫ìÂêç@ÂàÜÊîØÔºâ'
        type: string
        required: true
        default: 'xiaoran67/update@main'
      source_folder:
        description: 'Ê∫êÊñá‰ª∂Â§πË∑ØÂæÑ'
        type: string
        required: false
        default: 'output'
      
      # ÁõÆÊ†á‰ªìÂ∫ìÈÖçÁΩÆ
      target_repo:
        description: 'ÁõÆÊ†á‰ªìÂ∫ìÂêç'
        type: string
        required: true
        default: 'update'
      target_folder:
        description: 'ÁõÆÊ†áÊñá‰ª∂Â§πË∑ØÂæÑ'
        type: string
        required: false
        default: 'output'
      
      # GitHub‰∏ìÁî®ÈÖçÁΩÆ
      sync_strategy:
        description: 'GitHubÂêåÊ≠•Á≠ñÁï•Ôºà‰ªÖGitHubÂπ≥Âè∞ÊúâÊïàÔºâ'
        type: choice
        required: false
        options:
          - 'Â¢ûÈáè'
          - 'Ë¶ÜÁõñ'
        default: 'Â¢ûÈáè'
      commit_template:
        description: 'Êèê‰∫§‰ø°ÊÅØÊ®°ÊùøÔºà‰ªÖGitHubÂπ≥Âè∞ÊúâÊïàÔºâ'
        type: choice
        required: false
        options:
          - '‰ªÖÊó∂Èó¥'
          - 'ÂêåÊ≠•ËØ¥Êòé'
          - 'Ëá™ÂÆö‰πâ'
        default: '‰ªÖÊó∂Èó¥'
      custom_commit_msg:
        description: 'Ëá™ÂÆö‰πâÊèê‰∫§‰ø°ÊÅØÔºàÈÄâ"Ëá™ÂÆö‰πâ"Êó∂Â°´ÂÜôÔºâ'
        type: string
        required: false
        default: ''
      
      # TokenÈÖçÁΩÆ
      source_token_name:
        description: 'Ê∫ê‰ªìÂ∫ìToken'
        type: string
        required: true
        default: 'XIAORAN67_GITHUB_TOKEN'
      target_token_name:
        description: 'ÁõÆÊ†áÂπ≥Âè∞Token'
        type: string
        required: true
        default: 'XIAORAN67_GITEE_TOKEN'

jobs:
  universal-sync:
    runs-on: ubuntu-latest
    steps:
      # 1. ÁéØÂ¢ÉÊ£ÄÊü•ÂíåÈÖçÁΩÆËß£Êûê
      - name: üß© Ëß£ÊûêÈÖçÁΩÆ‰ø°ÊÅØ
        id: parse_config
        run: |
          echo "SYNC_PLATFORM=${{ inputs.sync_platform }}" >> $GITHUB_ENV
          
          # Ëß£ÊûêÊ∫ê‰ªìÂ∫ì
          if echo "${{ inputs.source_repo }}" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            IFS='/@' read -r source_user source_repo source_branch <<< "${{ inputs.source_repo }}"
            echo "SOURCE_USER=${source_user}" >> $GITHUB_ENV
            echo "SOURCE_REPO=${source_repo}" >> $GITHUB_ENV
            echo "SOURCE_BRANCH=${source_branch}" >> $GITHUB_ENV
          else
            echo "‚ùå Ê∫ê‰ªìÂ∫ìÊ†ºÂºèÈîôËØØ" && exit 1
          fi
          
          echo "SOURCE_FOLDER=${{ inputs.source_folder }}" >> $GITHUB_ENV
          echo "TARGET_REPO=${{ inputs.target_repo }}" >> $GITHUB_ENV
          echo "TARGET_FOLDER=${{ inputs.target_folder }}" >> $GITHUB_ENV
          echo "SYNC_STRATEGY=${{ inputs.sync_strategy }}" >> $GITHUB_ENV
          echo "COMMIT_TEMPLATE=${{ inputs.commit_template }}" >> $GITHUB_ENV
          echo "CUSTOM_COMMIT_MSG=${{ inputs.custom_commit_msg }}" >> $GITHUB_ENV

      # 2. TokenÊ†°È™å
      - name: üîë Ê†°È™åToken
        run: |
          if [ -z "${{ secrets[inputs.source_token_name] }}" ]; then
            echo "‚ùå Ê∫êToken‰∏çÂ≠òÂú®: ${{ inputs.source_token_name }}" && exit 1
          fi
          if [ -z "${{ secrets[inputs.target_token_name] }}" ]; then
            echo "‚ùå ÁõÆÊ†áToken‰∏çÂ≠òÂú®: ${{ inputs.target_token_name }}" && exit 1
          fi
          echo "‚úÖ TokenÊ†°È™åÈÄöËøá"

      # 3. Ê£ÄÂá∫Ê∫ê‰ªìÂ∫ì
      - name: üì• Ê£ÄÂá∫Ê∫ê‰ªìÂ∫ì
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_USER }}/${{ env.SOURCE_REPO }}
          ref: ${{ env.SOURCE_BRANCH }}
          path: source_repo
          token: ${{ secrets[inputs.source_token_name] }}
          fetch-depth: 1

      # 4. ÂáÜÂ§áÁõÆÊ†á‰ªìÂ∫ì
      - name: üì¶ ÂáÜÂ§áÁõÆÊ†á‰ªìÂ∫ì
        id: prepare_target
        run: |
          TARGET_TOKEN="${{ secrets[inputs.target_token_name] }}"
          
          case "${{ env.SYNC_PLATFORM }}" in
            "github")
              # GitHubÁõÆÊ†á‰ªìÂ∫ì
              TARGET_URL="https://${TARGET_TOKEN}@github.com/${{ env.SOURCE_USER }}/${{ env.TARGET_REPO }}.git"
              ;;
            "gitee")
              # GiteeÁõÆÊ†á‰ªìÂ∫ìÔºàÂõ∫ÂÆöÁî®Êà∑xiaoran67Ôºâ
              TARGET_URL="https://xiaoran67:${TARGET_TOKEN}@gitee.com/xiaoran67/${{ env.TARGET_REPO }}.git"
              ;;
            "gitcode")
              # GitCodeÁõÆÊ†á‰ªìÂ∫ìÔºàÂõ∫ÂÆöÁî®Êà∑xiaoran79Ôºâ
              TARGET_URL="https://xiaoran79:${TARGET_TOKEN}@gitcode.com/xiaoran79/${{ env.TARGET_REPO }}.git"
              ;;
          esac
          
          echo "TARGET_URL=${TARGET_URL}" >> $GITHUB_ENV
          
          # ÂÖãÈöÜÁõÆÊ†á‰ªìÂ∫ì
          git clone --depth=1 "${TARGET_URL}" target_repo || echo "‚ÑπÔ∏è ÁõÆÊ†á‰ªìÂ∫ìÂèØËÉΩ‰∏çÂ≠òÂú®ÔºåÂ∞ÜÂú®ÂêåÊ≠•Êó∂Â§ÑÁêÜ"

      # 5. ÂÆâË£Ö‰æùËµñ
      - name: üõ†Ô∏è ÂÆâË£Ö‰æùËµñ
        run: |
          sudo apt-get update && sudo apt-get install -y rsync jq

      # 6. Âπ≥Âè∞‰∏ìÁî®ÂêåÊ≠•ÈÄªËæë
      - name: üöÄ ÊâßË°åÂêåÊ≠•
        id: sync_execution
        run: |
          set -e
          
          case "${{ env.SYNC_PLATFORM }}" in
            "github")
              echo "üîÑ ÊâßË°åGitHubÊñá‰ª∂Â§πÂêåÊ≠•ÔºàÊó∂Èó¥Êà≥+Â§ßÂ∞èÊ†°È™åÔºâ..."
              source ./scripts/github_sync.sh
              ;;
            "gitee")
              echo "üîÑ ÊâßË°åGiteeÊñá‰ª∂Â§πÂ¢ûÈáèÂêåÊ≠•ÔºàÂìàÂ∏åÊ†°È™åÔºâ..."
              source ./scripts/gitee_sync.sh
              ;;
            "gitcode")
              echo "üîÑ ÊâßË°åGitCodeÊñá‰ª∂Â§πÂ¢ûÈáèÂêåÊ≠•ÔºàÂìàÂ∏åÊ†°È™åÔºâ..."
              source ./scripts/gitcode_sync.sh
              ;;
            *)
              echo "‚ùå ‰∏çÊîØÊåÅÁöÑÂπ≥Âè∞" && exit 1
              ;;
          esac

      # 7. Êé®ÈÄÅÊõ¥Êñ∞
      - name: üì§ Êé®ÈÄÅÊõ¥Êñ∞
        if: steps.sync_execution.outputs.changes_detected == 'true'
        run: |
          cd target_repo
          
          # ÈÖçÁΩÆGitË∫´‰ªΩ
          git config user.name "Universal Sync Bot"
          git config user.email "universal-sync@noreply.github.com"
          git add -A
          
          # ÁîüÊàêÊèê‰∫§‰ø°ÊÅØ
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          case "${{ env.SYNC_PLATFORM }}" in
            "github")
              # GitHub‰ΩøÁî®ÂéüÊúâÊèê‰∫§‰ø°ÊÅØÈÄªËæë
              if [ "${{ env.COMMIT_TEMPLATE }}" = "‰ªÖÊó∂Èó¥" ]; then
                COMMIT_MSG="üöÄ ${CURRENT_TIME}"
              elif [ "${{ env.COMMIT_TEMPLATE }}" = "ÂêåÊ≠•ËØ¥Êòé" ]; then
                SRC_INFO="${{ env.SOURCE_USER }}/${{ env.SOURCE_REPO }}:${{ env.SOURCE_BRANCH }}[${{ env.SOURCE_FOLDER }}]"
                TGT_INFO="${{ env.SOURCE_USER }}/${{ env.TARGET_REPO }}:${{ env.SOURCE_BRANCH }}[${{ env.TARGET_FOLDER }}]"
                COMMIT_MSG="üîÑ ÂêåÊ≠•ÔºàÊó∂Èó¥Êà≥+Â§ßÂ∞èÊ†°È™åÔºâ ${SRC_INFO} ‚Üí ${TGT_INFO}Ôºà${CURRENT_TIME}Ôºâ"
              else
                COMMIT_MSG="${{ env.CUSTOM_COMMIT_MSG }}"
                [ -z "$COMMIT_MSG" ] && COMMIT_MSG="üöÄ ${CURRENT_TIME}"
              fi
              ;;
            "gitee"|"gitcode")
              # GiteeÂíåGitCode‰ΩøÁî®ÁÆÄÂçïÊó∂Èó¥Êà≥
              COMMIT_MSG="‚úÖ ${CURRENT_TIME}"
              ;;
          esac
          
          git commit -m "${COMMIT_MSG}"
          
          # Ê†πÊçÆÂπ≥Âè∞ÂíåÁ≠ñÁï•ÂÜ≥ÂÆöÊé®ÈÄÅÊñπÂºè
          if [ "${{ env.SYNC_PLATFORM }}" = "github" ] && [ "${{ env.SYNC_STRATEGY }}" = "Ë¶ÜÁõñ" ]; then
            git push origin HEAD --force
          else
            git push origin HEAD
          fi

      # 8. ÁªìÊûúÊä•Âëä
      - name: üìä ÂêåÊ≠•Êä•Âëä
        run: |
          if [ "${{ steps.sync_execution.outputs.changes_detected }}" = "true" ]; then
            echo "‚úÖ ÂêåÊ≠•ÂÆåÊàêÔºÅ"
            echo "üìå Âπ≥Âè∞: ${{ env.SYNC_PLATFORM }}"
            echo "üìå Ê∫ê: ${{ env.SOURCE_USER }}/${{ env.SOURCE_REPO }}:${{ env.SOURCE_BRANCH }}"
            echo "üìå ÁõÆÊ†á: ${{ env.TARGET_REPO }}"
            echo "üìå ÂêåÊ≠•Ë∑ØÂæÑ: ${{ env.SOURCE_FOLDER }} ‚Üí ${{ env.TARGET_FOLDER }}"
          else
            echo "‚ÑπÔ∏è Êó†ÈúÄÂêåÊ≠•ÔºöÂÜÖÂÆπÂÆåÂÖ®‰∏ÄËá¥"
          fi

  # ËæÖÂä©ËÑöÊú¨ÂáÜÂ§á
  prepare-scripts:
    runs-on: ubuntu-latest
    steps:
      - name: üìù ÂàõÂª∫ÂêåÊ≠•ËÑöÊú¨
        run: |
          mkdir -p scripts
          
          # GitHubÂêåÊ≠•ËÑöÊú¨ÔºàÊó∂Èó¥Êà≥+Â§ßÂ∞èÊ†°È™åÔºâ
          cat > scripts/github_sync.sh << 'EOF'
          # GitHubÊñá‰ª∂Â§πÂêåÊ≠•ÈÄªËæëÔºàÁ¨¨‰∏Ä‰∏™Â∑•‰ΩúÊµÅÊ†∏ÂøÉÔºâ
          SOURCE_PATH="source_repo/${{ env.SOURCE_FOLDER }}"
          [ -z "${{ env.SOURCE_FOLDER }}" ] && SOURCE_PATH="source_repo"
          TARGET_PATH="target_repo/${{ env.TARGET_FOLDER }}"
          [ -z "${{ env.TARGET_FOLDER }}" ] && TARGET_PATH="target_repo"
          mkdir -p "${TARGET_PATH}"
          
          export TZ='Asia/Shanghai'
          
          if [ "${{ env.SYNC_STRATEGY }}" = "Â¢ûÈáè" ]; then
            rsync -av --times --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          else
            rsync -av --delete --force --times --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          fi
          
          cd target_repo
          if git status --porcelain | grep -q .; then
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
          EOF
          
          # GiteeÂêåÊ≠•ËÑöÊú¨ÔºàÂìàÂ∏åÊ†°È™åÔºâ
          cat > scripts/gitee_sync.sh << 'EOF'
          # GiteeÊñá‰ª∂Â§πÂ¢ûÈáèÂêåÊ≠•ÔºàÁ¨¨‰∫å‰∏™Â∑•‰ΩúÊµÅÊ†∏ÂøÉÔºâ
          SOURCE_PATH="source_repo/${{ env.SOURCE_FOLDER }}"
          TARGET_PATH="target_repo/${{ env.TARGET_FOLDER }}"
          mkdir -p "${TARGET_PATH}"
          
          # ËÆ°ÁÆóÊ∫êÊñá‰ª∂Â§πÂìàÂ∏å
          cd source_repo
          SRC_HASH=$(find "${{ env.SOURCE_FOLDER }}" -type f -exec sha1sum {} + | sort | sha1sum | awk '{print $1}')
          echo "Ê∫êÊñá‰ª∂Â§πÂìàÂ∏å: ${SRC_HASH}"
          
          # ËÆ°ÁÆóÁõÆÊ†áÊñá‰ª∂Â§πÂìàÂ∏å
          cd ../target_repo
          TGT_HASH=$(find "${{ env.TARGET_FOLDER }}" -type f -exec sha1sum {} + 2>/dev/null | sort | sha1sum | awk '{print $1}')
          if [ -z "$TGT_HASH" ]; then
            TGT_HASH="0000000000000000000000000000000000000000"
          fi
          echo "ÁõÆÊ†áÊñá‰ª∂Â§πÂìàÂ∏å: ${TGT_HASH}"
          
          if [ "$SRC_HASH" != "$TGT_HASH" ]; then
            echo "üîÑ ÂÜÖÂÆπ‰∏ç‰∏ÄËá¥ÔºåÊâßË°åÂ¢ûÈáèÂêåÊ≠•"
            rsync -av --delete "${SOURCE_PATH}/" "${TARGET_PATH}/"
            
            # ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûÈôÖÂèòÂåñ
            if git status --porcelain | grep -q .; then
              echo "changes_detected=true" >> $GITHUB_OUTPUT
            else
              echo "changes_detected=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚úÖ ÂÜÖÂÆπ‰∏ÄËá¥ÔºåË∑≥ËøáÂêåÊ≠•"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
          EOF
          
          # GitCodeÂêåÊ≠•ËÑöÊú¨ÔºàÂìàÂ∏åÊ†°È™åÔºâ
          cat > scripts/gitcode_sync.sh << 'EOF'
          # GitCodeÊñá‰ª∂Â§πÂ¢ûÈáèÂêåÊ≠•ÔºàÁ¨¨‰∏â‰∏™Â∑•‰ΩúÊµÅÊ†∏ÂøÉÔºâ
          SOURCE_PATH="source_repo/${{ env.SOURCE_FOLDER }}"
          TARGET_PATH="target_repo/${{ env.TARGET_FOLDER }}"
          mkdir -p "${TARGET_PATH}"
          
          # ËÆ°ÁÆóÊ∫êÊñá‰ª∂Â§πÂìàÂ∏å
          cd source_repo
          SRC_HASH=$(find "${{ env.SOURCE_FOLDER }}" -type f -exec sha1sum {} + | sort | sha1sum | awk '{print $1}')
          echo "Ê∫êÊñá‰ª∂Â§πÂìàÂ∏å: ${SRC_HASH}"
          
          # ËÆ°ÁÆóÁõÆÊ†áÊñá‰ª∂Â§πÂìàÂ∏å
          cd ../target_repo
          TGT_HASH=$(find "${{ env.TARGET_FOLDER }}" -type f -exec sha1sum {} + 2>/dev/null | sort | sha1sum | awk '{print $1}')
          if [ -z "$TGT_HASH" ]; then
            TGT_HASH="0000000000000000000000000000000000000000"
          fi
          echo "ÁõÆÊ†áÊñá‰ª∂Â§πÂìàÂ∏å: ${TGT_HASH}"
          
          if [ "$SRC_HASH" != "$TGT_HASH" ]; then
            echo "üîÑ ÂÜÖÂÆπ‰∏ç‰∏ÄËá¥ÔºåÊâßË°åÂ¢ûÈáèÂêåÊ≠•"
            rsync -av --delete "${SOURCE_PATH}/" "${TARGET_PATH}/"
            
            # ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆûÈôÖÂèòÂåñ
            if git status --porcelain | grep -q .; then
              echo "changes_detected=true" >> $GITHUB_OUTPUT
            else
              echo "changes_detected=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚úÖ ÂÜÖÂÆπ‰∏ÄËá¥ÔºåË∑≥ËøáÂêåÊ≠•"
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi
          EOF
